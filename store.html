<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shop Demo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  #cart-modal {
    position: fixed;
    top: 60px;
    right: 20px;
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
    padding: 15px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  #btn-cart-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1001;
  }
</style>
</head>
<body>
<div class="container mt-4">
  <h1>🛒 Welcome to Our Shop</h1>

<div class="row mb-3">
  <div class="col-md-4">
    <input type="text" id="search-name" class="form-control" placeholder="🔍 Tìm kiếm theo tên..." />
  </div>
  <div class="col-md-4">
    <select id="filter-category" class="form-select">
      <option value="">-- Lọc theo phân loại --</option>
      <!-- Các category sẽ được fill động ở JS -->
    </select>
  </div>
  <div class="col-md-4">
    <select id="sort-price" class="form-select">
      <option value="default">Sắp xếp theo giá</option>
      <option value="asc">Giá thấp → cao</option>
      <option value="desc">Giá cao → thấp</option>
    </select>
  </div>
</div>



  <div id="product-list" class="row gy-4 mt-3">
    <!-- Products will render here -->
  </div>
</div>

<!-- Nút bật/tắt giỏ hàng -->
<button id="btn-cart-toggle" class="btn btn-success">
  🛍️ Giỏ hàng (<span id="cart-count">0</span>)
</button>

<!-- Giỏ hàng popup -->
<div id="cart-modal" class="shadow">
  <h5>🛍️ Giỏ hàng của bạn</h5>
  <ul id="cart-items" class="list-group mb-3">
    <li class="list-group-item">Giỏ hàng trống.</li>
  </ul>
  <div>
    <strong>Tổng tiền: </strong><span id="cart-total">0 ₫</span>
  </div>
  <button class="btn btn-primary mt-3 w-100" onclick="checkout()">Thanh toán</button>
</div>

<script>

let currentSearch = "";
let currentCategory = "";
let currentSort = "default";

const apiUrl = "https://localhost:7023/api/products";

let products = [];
let cart = JSON.parse(localStorage.getItem('cart')) || {};

async function loadProducts() {
  try {
    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error("HTTP status " + res.status);
    products = await res.json();
    renderCategoryOptions();	
    renderProducts();
    updateCartCount();
    renderCart();
  } catch (err) {
    alert("Không thể tải danh sách sản phẩm!");
    console.error(err);
  }
}

function renderCategoryOptions() {
  const select = document.getElementById('filter-category');
  const categories = [...new Set(products.map(p => p.category))]; // lấy danh sách không trùng
  select.innerHTML = '<option value="">-- Lọc theo phân loại --</option>';

  categories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });
}


function renderProducts() {
  const container = document.getElementById('product-list');
  container.innerHTML = '';

  // Lọc theo tên (search)
  let filtered = products.filter(p =>
    p.name.toLowerCase().includes(currentSearch.toLowerCase())
  );

  // Lọc theo category nếu có chọn
  if (currentCategory) {
    filtered = filtered.filter(p => p.category === currentCategory);
  }

  // Sắp xếp theo giá
  if (currentSort === 'asc') {
    filtered.sort((a, b) => a.price - b.price);
  } else if (currentSort === 'desc') {
    filtered.sort((a, b) => b.price - a.price);
  }

  // Nếu không có sản phẩm phù hợp thì hiển thị thông báo
  if (filtered.length === 0) {
    container.innerHTML = '<p>Không tìm thấy sản phẩm phù hợp.</p>';
    return;
  }

// Render danh sách sản phẩm đã lọc và sắp xếp
  filtered.forEach(p => {
    const col = document.createElement('div');
    col.className = 'col-md-4';

    col.innerHTML = `
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${p.name}</h5>
          <p class="card-text mb-1"><strong>Giá:</strong> ${p.price.toLocaleString()} ₫</p>
          <p class="card-text mb-1">📦SL: ${p.quantity}</p>
          <p class="card-text mb-3"><em>🏷️${p.category}</em></p>
          <input type="number" min="1" max="${p.quantity}" value="1" class="form-control mb-3 quantity-input" data-id="${p.id}" />
          <button class="btn btn-primary mt-auto w-100 add-to-cart" data-id="${p.id}">Thêm vào giỏ</button>
        </div>
      </div>
    `;
    container.appendChild(col);
  });

  // Thêm sự kiện cho nút thêm vào giỏ
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      const input = document.querySelector(`.quantity-input[data-id="${id}"]`);
      const qty = parseInt(input.value);
      addToCart(id, qty);
    });
  });
}

function addToCart(productId, quantity) {
  const product = products.find(p => p.id == productId);
  if (!product) return alert("Sản phẩm không tồn tại");

  const qtyInCart = cart[productId] || 0;
  if (quantity + qtyInCart > product.quantity) {
    return alert(`Số lượng trong kho chỉ còn ${product.quantity}. Bạn đã có ${qtyInCart} trong giỏ.`);
  }

  cart[productId] = qtyInCart + quantity;
  localStorage.setItem('cart', JSON.stringify(cart));
  alert(`Đã thêm ${quantity} "${product.name}" vào giỏ.`);
  updateCartCount();
  renderCart();
}



function renderCart() {
  const cartItems = document.getElementById('cart-items');
  cartItems.innerHTML = '';

  const entries = Object.entries(cart);
  if (entries.length === 0) {
    cartItems.innerHTML = '<li class="list-group-item">Giỏ hàng trống.</li>';
    document.getElementById('cart-total').textContent = '0 ₫';
    return;
  }

  let total = 0;
  entries.forEach(([id, qty]) => {
    const product = products.find(p => p.id == id);
    if (!product) return;
    const subTotal = product.price * qty;
    total += subTotal;

    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      <div>
        ${product.name} <br/>
        <small>Giá: ${product.price.toLocaleString()} ₫ x ${qty}</small>
      </div>
      <div>
        <strong>${subTotal.toLocaleString()} ₫</strong>
      </div>
    `;
    cartItems.appendChild(li);
  });

  document.getElementById('cart-total').textContent = total.toLocaleString() + ' ₫';
}

function updateCartCount() {
  const count = Object.values(cart).reduce((a,b) => a + b, 0);
  document.getElementById('cart-count').textContent = count;
}

async function checkout() {
  if (Object.keys(cart).length === 0) {
    alert("Giỏ hàng trống!");
    return;
  }

  try {
    // 1. Gửi request giảm số lượng từng sản phẩm
    for (const [productId, qty] of Object.entries(cart)) {
      const product = products.find(p => p.id == productId);
      if (!product) continue;

      // Tính số lượng mới
      const newQuantity = product.quantity - qty;
      if (newQuantity < 0) {
        alert(`Sản phẩm ${product.name} không đủ số lượng để thanh toán.`);
        return;
      }

      // Gửi request cập nhật số lượng mới về backend
      const res = await fetch(`${apiUrl}/${productId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...product, quantity: newQuantity }),
      });

      if (!res.ok) {
        throw new Error(`Cập nhật sản phẩm ${product.name} thất bại`);
      }
    }

    alert("Thanh toán thành công!");

    // 2. Xóa giỏ hàng local
    cart = {};
    localStorage.setItem('cart', JSON.stringify(cart));

    // 3. Tải lại danh sách sản phẩm mới nhất
    await loadProducts();

    // 4. Cập nhật UI giỏ hàng
    renderCart();
    updateCartCount();

  } catch (error) {
    alert("Thanh toán thất bại: " + error.message);
    console.error(error);
  }
}


// Bật tắt giỏ hàng popup
const btnCartToggle = document.getElementById('btn-cart-toggle');
const cartModal = document.getElementById('cart-modal');
btnCartToggle.onclick = () => {
  cartModal.style.display = cartModal.style.display === 'block' ? 'none' : 'block';
};

// Load sản phẩm khi trang tải xong
window.addEventListener('load', loadProducts);

// Bắt sự kiện tìm kiếm
document.getElementById('search-name').addEventListener('input', e => {
  currentSearch = e.target.value;
  renderProducts();
});

// Bắt sự kiện chọn category
document.getElementById('filter-category').addEventListener('change', e => {
  currentCategory = e.target.value;
  renderProducts();
});

// Bắt sự kiện chọn sắp xếp giá
document.getElementById('sort-price').addEventListener('change', e => {
  currentSort = e.target.value;
  renderProducts();
});

</script>
</body>
</html>
